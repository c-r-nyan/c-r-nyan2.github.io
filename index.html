<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>海底迷宮</title>
<style>
/* 基本スタイル */
body {
    font-family:'メイリオ', 'Meiryo', sans-serif;
    margin:0;
    padding:0;
    width:100vw;
    height:100vh;
    overflow: hidden;

    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    -moz-user-select: none;
    -khtml-user-select: none;
    touch-action: none;

    /* 背景画像に変更 */
    background: black;url('images/underwater.jpg') no-repeat center center fixed;    
    background-size: cover;
    color: white;

    display:flex; justify-content:center; align-items:center;
    position:relative;
}
.container { 
  text-align:center; 
  position: relative; 
}
.welcome {
  font-size:2.5em; opacity:0;
  text-shadow:2px 2px 3px #008cff, -2px -2px 3px #b00000;
  animation:fadeInOut 5s forwards;
}
.puzzle {
  display:inline-block; font-size:3em; opacity:0;
  animation:showPuzzle 2s forwards, fadeOutPuzzle 2s forwards;
  animation-delay:5s, 9s;
}
.number {
  display:inline-block; font-size:3em; opacity:0; margin-left:10px;
  animation:slideNumber 2s forwards, fadeOutNumber 2s forwards; 
  animation-delay:6s, 9s;
}
/* ハンバーガーメニュー */
.menu-btn {
  position:fixed; top:20px; right:20px;
  width:24px; height:20px;
  display:flex; flex-direction:column; justify-content:space-around;
  cursor:pointer; opacity:0; pointer-events:none; transition:opacity 1s ease;
}
.menu-btn span { display:block; height:3px; background:white; border-radius:2px; transition:0.4s; }
.menu-btn.active span:nth-child(1) { transform:rotate(45deg) translate(5px,5px); }
.menu-btn.active span:nth-child(2) { opacity:0; }
.menu-btn.active span:nth-child(3) { transform:rotate(-45deg) translate(4px,-4px); }

.menu {
  position:fixed; top:0; left:0; width:200px; height:100vh; background:#333;
  display:none; flex-direction:column; padding-top:60px; align-items:center;
}
.menu.active { display:flex; }
.menu a { color:white; text-decoration:none; margin:20px 0; font-size:1.5em; }
.menu .points {
  color: #ff0;
  font-size: 1.3em;
  margin: 30px 0 10px 0;
  border-top: 1px solid #555;
  width: 80%;
  padding-top: 10px;
  text-align: center;
  display: none;
}

/* タイマー */
.timer {
  position:fixed; bottom:20px; right:20px; font-size:2em;
  color:#fff;
  font-family:monospace, 'Arial Black', sans-serif;
  opacity:0; transition:opacity 1s ease;
}

/* 謎タイトル */
.puzzle2 {
  position:fixed; top:10%; left:50%; transform:translateX(-50%);
  font-size:3em; opacity:0; transition:opacity 1s ease;
}

/* 文字入力マス */
.grid-wrapper {
  position:fixed;
  top:25%;
  left:50%;
  transform:translateX(-50%);
}
.grid {
  display:flex; gap:15px; opacity:0; transition:opacity 1s ease;
}
.grid input {
  width:90px; 
  height:90px; 
  border:2px solid white; 
  background: black; /* ← ここを変更 */
  color:white; 
  font-size:3em; 
  text-align:center;
  -moz-appearance:textfield;
  transition: border-color 0.3s, box-shadow 0.3s;
  border-radius:8px; /* optional: 角丸 */
}
.grid input::-webkit-outer-spin-button,
.grid input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }

/* 正解時エフェクト */
.grid.correct input {
  border-color:#00ff77;
  box-shadow:0 0 12px 4px #00ff77;
  animation: correct-glow 1.2s ease;
}
@keyframes correct-glow {
  0% { box-shadow:0 0 0px 0px #00ff77; border-color:#00ff77;}
  50% { box-shadow:0 0 16px 8px #00ff77; border-color:#00ff77;}
  100% { box-shadow:0 0 0px 0px #00ff77; border-color:#00ff77;}
}

/* 不正解時エフェクト */
.grid.incorrect input {
  border-color: #ff0000;
  box-shadow: 0 0 12px 4px #ff0000;
  animation: incorrect-glow 1s ease;
}

@keyframes incorrect-glow {
  0% { box-shadow:0 0 0px 0px #ff0000; border-color:#ff0000;}
  50% { box-shadow:0 0 16px 8px #ff0000; border-color:#ff0000;}
  100% { box-shadow:0 0 0px 0px #ff0000; border-color:#ff0000;}
}

/* フリックキーボード */
.keyboard {
  position:fixed;
  top:40%;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  width:360px; /* ← 横幅調整 */
  display:grid;
  grid-template-columns: repeat(3, 1fr); /* 3列 */
  grid-auto-rows:100px; /* 行の高さ */
  gap:15px;
  justify-items:center;
  align-items:center;
  z-index:100;
  opacity:0;
  pointer-events:none;
  transition: opacity 1s, transform 1s;
}
.keyboard.show {
  opacity:1;
  pointer-events:auto;
  transform:translateX(-50%) translateY(0);
}
.keyboard button {
  width:100px;
  height:100px;
  font-size:2.2em;
  cursor:pointer;
  color:black;
  background:#ccc;
  border:2px solid white;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.keyboard.hide {
  opacity:0 !important;
  pointer-events:none !important;
  transition: opacity 0.5s;
}
.kb_key, .kb_key_flick {
  width:100px;
  height:100px;
  font-size:2.2em;
  cursor:pointer;
  color:black;
  background:#ccc;
  border:2px solid white;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.kb_no_input { background:#A4A4A4; }
.kb_key_flick { position:absolute; z-index:10; background:white; }
.kb_key_shadow { position:absolute; font-size:24px; font-weight:700; filter:drop-shadow(3px 3px 3px rgba(0,0,0,0.5)); pointer-events:none; }
.kb_key_u { clip-path: polygon(0 0, 100% 0, 100% 62%, 50% 100%, 0 62%); line-height:56px; text-align:center; }
.kb_key_d { clip-path: polygon(50% 1%, 100% 38%, 100% 100%, 0 100%, 0% 38%); line-height:60px; }
.kb_key_l { clip-path: polygon(0 0, 75% 0, 100% 50%, 75% 100%, 0 100%); letter-spacing:4px; }
.kb_key_r { clip-path: polygon(25% 0, 100% 0, 100% 100%, 25% 100%, 0 50%); letter-spacing:-10px; }
.transparent { opacity:0; visibility:collapse; }
.gray_for_touch { background-color: #8E8E8E; }
#switch_container { display:flex; justify-content:center; align-items:center; flex-direction:column; }
.switch { text-align:center; height:18px; }
#switch1 { margin-left:2px; }
#switch3 { font-size:14px; margin-top:-4px; }

/* 振動 */
.shake { animation:shake 0.25s ease-in-out 3; }
@keyframes shake {
  0% { transform:translateX(0); }
  25% { transform:translateX(-3px); }
  50% { transform:translateX(3px); }
  75% { transform:translateX(-3px); }
  100% { transform:translateX(0); }
}

/* TIMEUP/ALL PASSED中央表示 */
#timeup-message {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:2em;
  color:#fff;
  font-family: 'Arial Black', sans-serif;
  text-shadow:2px 2px 8px #000, 0 0 10px #fff;
  z-index:200;
  background:rgba(0,0,0,0.7);
  padding:0.5em 1em;
  border-radius:20px;
  letter-spacing:0.1em;
  text-align:center;
}

@keyframes fadeInOut {0%{opacity:0; transform:scale(0.8);}20%{opacity:1; transform:scale(1);}70%{opacity:1;}100%{opacity:0; transform:scale(1);}}
@keyframes showPuzzle {0%{opacity:0; transform:translateY(20px);}50%{opacity:1; transform:translateY(0);}100%{opacity:1; transform:translateX(-30px);}}
@keyframes slideNumber {0%{opacity:0;}100%{opacity:1;}}
@keyframes fadeOutPuzzle {from{opacity:1;} to{opacity:0;}}
@keyframes fadeOutNumber {from{opacity:1;} to{opacity:0;}}
</style>
</head>
<body>

<div class="container" id="container">
  <div class="welcome">E-203</div>
  <div>
    <span class="puzzle">謎</span>
    <span class="number" id="mainNumber">❶</span>
  </div>
</div>

<div class="puzzle2" id="puzzle2">謎❶</div>

<div class="grid-wrapper" id="gridWrapper">
  <div class="grid" id="grid">
    <input type="text" maxlength="1" readonly>
    <input type="text" maxlength="1" readonly>
    <input type="text" maxlength="1" readonly>
    <input type="text" maxlength="1" readonly>
  </div>
</div>

<!-- フリックキーボード -->
<div class="keyboard" id="keyboard">
  <div class="kb_key_shadow"><div class="kb_key_flick kb_key_u transparent"></div></div>
  <div class="kb_key_shadow"><div class="kb_key_flick kb_key_d transparent"></div></div>
  <div class="kb_key_shadow"><div class="kb_key_flick kb_key_l transparent"></div></div>
  <div class="kb_key_shadow"><div class="kb_key_flick kb_key_r transparent"></div></div>

  <div class="kb_key">あ</div>
  <div class="kb_key">か</div>
  <div class="kb_key">さ</div>

  <div class="kb_key">た</div>
  <div class="kb_key">な</div>
  <div class="kb_key">は</div>

  <div class="kb_key">ま</div>
  <div class="kb_key">や</div>
  <div class="kb_key">ら</div>

  <div id="kb_key_switch" class="kb_key no_flick">
    <div id="switch_container">
      <div id="switch1" class="switch">゛</div>
      <div id="switch2" class="switch">゜</div>
      <div id="switch3" class="switch">小</div>
    </div>
  </div>
  <div class="kb_key">わ</div>
  <div id="kb_key_bs" class="kb_key no_flick">←</div>
  <button id="keyboard_ok">OK</button>
</div>

<div id="timeup-message">TIME UP</div>

<div class="menu" id="menu">
  <a href="#">ホーム</a>
  <a href="#">マップ</a>
  <a href="#">設計図</a>
  <div class="points" id="points"></div>
</div>

<div class="menu-btn" id="menuBtn"><span></span><span></span><span></span></div>
<div class="timer" id="timer">05:00</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// 元のゲームJSはそのまま
const menuBtn=document.getElementById('menuBtn');
const menu=document.getElementById('menu');
const timerEl=document.getElementById('timer');
const puzzle2=document.getElementById('puzzle2');
const grid=document.getElementById('grid');
const gridWrapper=document.getElementById('gridWrapper');
const inputs=grid.querySelectorAll("input");
const keyboard=document.getElementById('keyboard');
const puzzleSpan = document.querySelector('.puzzle');
const numberSpan = document.getElementById('mainNumber');
const timeupMessage = document.getElementById('timeup-message');
const container = document.getElementById('container');
const pointsDiv = document.getElementById('points');
const welcome = document.querySelector('.welcome');

let inputValue="";
const answers = ["あいうえ", "かきくけ", "さしすせ"]; // ← 3問の答えを配列で管理
let puzzleIndex = 1;
const puzzleMax = answers.length;
let isTimeup = false;
let solvedCount = 0;
let timerInterval = null;
let allPassed = false;

function setPuzzleTitle(idx) {
  const marks = ["❶","❷","❸"];
  puzzle2.textContent = "謎" + marks[idx-1];
  numberSpan.textContent = marks[idx-1];
}
setPuzzleTitle(puzzleIndex);

// OKボタン
$('#keyboard_ok').on('click',()=>{
  if(isTimeup || allPassed) return;

  if(inputValue === answers[puzzleIndex-1]){   // ← ここで現在の答えと照合
      grid.classList.add("correct");
      setTimeout(()=>{ grid.classList.remove("correct"); }, 1500);
      solvedCount++;

      if(puzzleIndex < puzzleMax){
        puzzleIndex++;
        setPuzzleTitle(puzzleIndex);
        inputValue = "";
        inputs.forEach(input=>input.value="");
      } else {
        inputValue = "";
        inputs.forEach(input=>input.value="");
        allPassed = true;
        endAllPassed();
      }
} else {
    grid.classList.add("shake", "incorrect");  // ← ここに incorrect を追加
    setTimeout(()=>grid.classList.remove("shake", "incorrect"),600);
    inputValue="";
    inputs.forEach(input=>input.value="");
}
});

// 10秒後にキーボード・UI表示
setTimeout(()=>{
  menuBtn.style.opacity="1"; menuBtn.style.pointerEvents="auto";
  timerEl.style.opacity="1";
  puzzle2.style.opacity="1";
  grid.style.opacity="1";
  keyboard.classList.add('show');
  startTimer(5*60,timerEl);
},10000);

// メニュー
menuBtn.addEventListener('click',()=>{
  menuBtn.classList.toggle('active');
  menu.classList.toggle('active');
  if(isTimeup || allPassed) {
    pointsDiv.textContent = `ポイント: ${solvedCount * 100}`;
    pointsDiv.style.display = "block";
  } else pointsDiv.style.display = "none";
});

// タイマー
function startTimer(duration,display){
  let timer=duration;
  timerInterval = setInterval(()=>{
    if(isTimeup || allPassed) { clearInterval(timerInterval); return; }
    let minutes=Math.floor(timer/60);
    let seconds=timer%60;
    minutes=minutes<10?"0"+minutes:minutes;
    seconds=seconds<10?"0"+seconds:seconds;
    display.textContent=minutes+":"+seconds;
    if(--timer<0){
      clearInterval(timerInterval);
      showTimeup();
    }
  },1000);
}

function showTimeup() {
  isTimeup = true;
  gridWrapper.style.display = "none";
  keyboard.classList.add("hide");
  puzzle2.style.display = "none";
  container.style.display = "none";
  timerEl.style.display = "none";
  timeupMessage.textContent = "TIME UP";
  timeupMessage.style.display = "block";
}

function endAllPassed() {
  if(timerInterval) clearInterval(timerInterval);
  gridWrapper.style.display = "none";
  keyboard.classList.add("hide");
  puzzle2.style.display = "none";
  container.style.display = "none";
  timerEl.style.display = "none";
  timeupMessage.textContent = "ALL PASSED";
  timeupMessage.style.display = "block";
}

if (welcome) {
  welcome.addEventListener('animationend', () => { welcome.style.display = 'none'; });
}

// フリックキーボード処理
const l_word = [
['あ','い','う','え','お'], ['か','き','く','け','こ'], ['さ','し','す','せ','そ'],
['た','ち','つ','て','と'], ['な','に','ぬ','ね','の'], ['は','ひ','ふ','へ','ほ'],
['ま','み','む','め','も'], ['や','','ゆ','','よ'], ['ら','り','る','れ','ろ'],
['わ','を','ん','ー','']
];
const l_word_switch = [
['あ','ぁ'], ['い','ぃ'], ['う','ぅ'], ['え','ぇ'], ['お','ぉ'],
['か','が'], ['き','ぎ'], ['く','ぐ'], ['け','げ'], ['こ','ご'],
['さ','ざ'], ['し','じ'], ['す','ず'], ['せ','ぜ'], ['そ','ぞ'],
['た','だ'], ['ち','ぢ'], ['つ','っ','づ'], ['て','で'], ['と','ど'],
['は','ば','ぱ'], ['ひ','び','ぴ'], ['ふ','ぶ','ぷ'], ['へ','べ','ぺ'], ['ほ','ぼ','ぽ'],
['や','ゃ'], ['ゆ','ゅ'], ['よ','ょ']
];
let direction='', position='';

// タッチ操作
$(document).on('touchstart', '.kb_key:not(.no_flick)', function(e){
  $(e.currentTarget).addClass('gray_for_touch');
  position = e.originalEvent.touches[0]; direction='c';
  let offset=$(e.currentTarget).offset();
  $('.kb_key_u').offset({top:offset.top-48,left:offset.left});
  $('.kb_key_d').offset({top:offset.top+48,left:offset.left});
  $('.kb_key_l').offset({top:offset.top,left:offset.left-48});
  $('.kb_key_r').offset({top:offset.top,left:offset.left+48});
  let l = l_word.find(x=>x.includes($(e.currentTarget).text()));
  $('.kb_key_u').text(l[2]); $('.kb_key_d').text(l[4]);
  $('.kb_key_l').text(l[1]); $('.kb_key_r').text(l[3]);
});
$(document).on('touchmove', '.kb_key:not(.no_flick)', function(e){
  direction='c';
  $('.kb_key_u,.kb_key_d,.kb_key_l,.kb_key_r').addClass('transparent');
  $(e.currentTarget).addClass('gray_for_touch').removeClass('transparent');
  let newPos = e.originalEvent.touches[0];
  let u=position.screenY-newPos.screenY, d=newPos.screenY-position.screenY;
  let l=position.screenX-newPos.screenX, r=newPos.screenX-position.screenX;
  let max=Math.max(u,d,l,r); if(max<20) return;
  $(e.currentTarget).removeClass('gray_for_touch').addClass('transparent');
  if(max==u) direction='u', $('.kb_key_u').removeClass('transparent');
  else if(max==d) direction='d', $('.kb_key_d').removeClass('transparent');
  else if(max==l) direction='l', $('.kb_key_l').removeClass('transparent');
  else if(max==r) direction='r', $('.kb_key_r').removeClass('transparent');
});
$(document).on('touchend', '.kb_key:not(.no_flick)', function(e){
  $('.kb_key_u,.kb_key_d,.kb_key_l,.kb_key_r').addClass('transparent');
  $(e.currentTarget).removeClass('gray_for_touch transparent');
  let key=$(e.currentTarget).text();
  let l = l_word.find(x=>x.includes(key));
  let idx = direction=='c'?0:direction=='u'?2:direction=='d'?4:direction=='l'?1:3;
  if(l[idx]=='') return;
  if(inputValue.length<4){
    inputValue+=l[idx];
    inputs[inputValue.length-1].value = l[idx];
  }
});

// スイッチ・バックスペース
$(document).on('touchstart','#kb_key_switch',function(e){
  $(e.currentTarget).addClass('gray_for_touch');
  let last = inputValue.slice(-1);
  let l_switch = l_word_switch.find(x=>x.includes(last));
  if(!l_switch) return;
  let idx = (l_switch.indexOf(last)+1)%l_switch.length;
  inputValue = inputValue.slice(0,-1)+l_switch[idx];
  inputs[inputValue.length-1].value = l_switch[idx];
});
$(document).on('touchstart','#kb_key_bs',function(e){
  $(e.currentTarget).addClass('gray_for_touch');
  if(inputValue.length>0){
    inputs[inputValue.length-1].value="";
    inputValue=inputValue.slice(0,-1);
  }
});
$(document).on('touchend','#kb_key_switch,#kb_key_bs',function(e){
  $(e.currentTarget).removeClass('gray_for_touch');
});
</script>
</body>
</html>
